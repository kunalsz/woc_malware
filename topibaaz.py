from flask import Flask,render_template
import firebase_admin
from firebase_admin import db,credentials,storage
from datetime import datetime,timedelta

#set credentials
cred = credentials.Certificate('credentials.json')
firebase_admin.initialize_app(cred,{'databaseURL':'https://testing-41a99-default-rtdb.asia-southeast1.firebasedatabase.app/','storageBucket':'testing-41a99.appspot.com'})

#references
ref = db.reference('/logs')

def download_file(dest):
    try:
        bucket = storage.bucket()
        blob = bucket.blob(dest)
        #expiration
        expiration_time = datetime.utcnow() + timedelta(minutes=2)
        url = blob.generate_signed_url(expiration=expiration_time,response_disposition="attachment")

        return url
    except:
        pass

#get data from the database
def get_data():
    #final html strings to send to the html page
    final_html = '' 
    for item in ref.get(): #item is a dictionary
        try:
            day= item['day']
            month= item['month']
            year= item['year']
            date = f'{day}/{month}/{year}'

            second= item['second']
            minute= item['minute']
            hour= item['hour']
            time = f'{hour}:{minute}:{second}'

            msg= item['message']
            file_path= 'test/'+item['file_path']
            file_path = file_path.replace('\\','/')
            pid = item['process']
            
            download_link = download_file(file_path)

            html_code = f'<tr><td>{pid}</td><td>{msg}</td><td>{date}</td><td>{time}</td><td><a href="{download_link}">download!</td></tr>'

            final_html = final_html + str(html_code)
            
        except:
            pass
    return final_html


#get_data()
app = Flask(__name__)   


@app.route('/')
def index():
    final_html = get_data()
    return render_template('topi_manager.html',html_code=final_html)

app.run(host="0.0.0.0",port=5000)
